pipeline {
    agent any
    environment {
       ENVIRONMENT = 'DEV'
       
    }
    stages {
       
               stage('Setup parameters') {
            steps {
                script { 
                    properties([
                        parameters([
                            choice(
                                choices: ['DEV', 'QA' , 'PROD'], 
                                name: 'ENVIRONMENT'
                            )
                        ])
                    ])
                }
            }
        }
       
       
       
       
        stage('NPM Initialization') {
            steps {
                echo 'Pull code and build'
                 sh '''
                mkdir my-express-application && cd my-express-application
                npm init -f
                  '''
        }
     }
        stage('Build') {
            steps {
                    echo 'Building the code===='
                   sh ''' npm install --save express serverless-http '''
                    echo 'Run tests and publish results'
                    
            }
        }
       // stage('Test') {
       //     steps {
       //         echo 'Run tests and publish results'
       //         sh 'npm run test'
      //      }
     //   }

        stage('Deploy to Development') {
        
         when { 
        environment name: 'ENVIRONMENT', value: 'DEV' 
    }
       // when {
         //       expression { 
        //           return params.ENVIRONMENT == 'DEV'
         //       }
        //    }
           
            steps {
                echo 'Deploy package to Dev'
                sh "serverless deploy --alias DEV --region ${env.DEPLOY_REGION} --version ${VERSION}"
            }
        }
       
    }
    }
