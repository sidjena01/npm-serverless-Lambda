pipeline {
    agent any
    stages {
        // choice(QA, DEV)
        stage('NPM Initialization') {
            steps {
                echo 'Pull code and build'
                 sh '''
                mkdir my-express-application && cd my-express-application
                npm init -f
                  '''
        }
     }
        stage('Build') {
            steps {
                    echo 'Building the code===='
                   sh ''' npm install --save express serverless-http '''
                    echo 'Run tests and publish results'
                    
            }
        }
        stage('Test') {
            steps {
                echo 'Run tests and publish results'
                sh 'npm run test'
            }
        }

        stage('Deploy to Development') {
        when {
                expression { 
                   return params.ENVIRONMENT == 'DEV'
                }
            }
            environment {
                VERSION = bat(returnStdout: true, script: '@npm run get-version --silent').trim()
            }
            steps {
                echo 'Deploy package to Dev'
                sh "serverless deploy --alias DEV --region ${env.DEPLOY_REGION} --version ${VERSION}"
            }
        }
       
    }
    }
